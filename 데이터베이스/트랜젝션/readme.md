# 트랜잭션

<br>

### 데이터베이스의 상태를 변환시키는 하나의 논리적 기능을 수행하기 위한 작업의 단위 또는 한꺼번에 모두 수행되어야 할 일련의 연산들을 의미한다.

- ### 데이테베이스는 정확한 데이터를 유지하며 오류 발생 시 빠르게 복구하고, 데이터베이스가 항상 정확하고 일관된 상태를 유지할 수 있도록 다양한 기능을 제공하는데 그 중심에서 가장 중요한 역할을 하는 것이 바로 트랜잭션이다.
  - 트랜잭션을 관리함으로써 데이터베이스의 회복과 병행제어가 가능
- ### 작업 수행에 필요한 SQL 문들의 모임
- ### 트랜잭션의 모든 명령문이 완벽하게 처리되거나 하나도 처리되지 않아야 데이터 베이스 모순이 없는 일관된 상태를 유지
- ### 트랜잭션은 데이터베이스에 장애가 발생했을 때 복구잡업을 수행하거나, 다수의 사용자가 동시에 사용할 수 있도록 제어 작업을 하는 데 중요한 단위로 사용.
<br>

## 트랜잭션의 특징(ACID)

<br>

### 트랜잭션이 성공적으로 처리되어 데이터베이스의 무결성과 일관성을 보장하려면 4가지 특성을 만족해야 한다.

1. ### Atomicity(원자성)
2. ### Consistendcy(일관성)
3. ### Isolation(격리성)
4. ### Durability(지속성)

## 1. Atomicity(원자성)

- 트랜잭션이 데이터베이스에 모두 반영되던가, 아니면 전혀 반영되지 않아야 한다는 것이다.

## 2. 일관성(Consistendcy)

- 트랜잭션이 성공적으로 수행된 후에도 데이터베이스가 일관성 있는 상태를 유지해야 함을 의미 ex) 게좌 이체 진행

## 3. 격리성(Isolation)

- 현재 수행 중인 트랜잭션이 완료될 때까지 트랜잭션이 생성한 중간 연산 결과에 다른 트랜잭션이 접근할 수 없다.
- 각 트랜잭션이 독립적으로 수행될 수 있도록 한다.

## 4. 지속성(Durability)

- 트랜잭션이 성공적으로 완료된 후 데이터베이스에 반영한 수행 결과는 손실되지 않고 영구적으로 존재해야한다.
- 시스템 장애가 발생하더라도 작업 결과는 데이터베이스가 그대로 남아있어야 한다.
- 지속성 보장을 위해 시스템 장애가 발생했을 때 데이터베이스를 원래 상태로 복구하는 회복 기능이 필요
  <br>

## 트랜잭션의 상태

<br>

![image](https://user-images.githubusercontent.com/71022555/137618034-8e48092e-2cdc-40d1-8105-30fe3a475e82.png)

### 활동(Active) : 트랜잭션이 실행중인 상태

<br>

### 실패(Failed) : 트랜잭션 실행에 오류가 발생하여 중단된 상태

<br>

### 철회(Aborted) : 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태

<br>

### 부분 완료(Partially Committed) : 트랜잭션의 마지막 연산까지 실행했지만, Commit 연산이 실행되기 직전의 상태

<br>

### 완료(Committed) : 트랜잭션이 성공적으로 종료되어 Commit 연산을 실행한 후의 상태

<br>

## 회복기법

---

<br>

## 1. 로그 기반 회복 기법

### 지연갱신 회복 기법(Deferred Update)

- 트랜잭션의 부분 완료 상태에선 변경 내용을 로그 파일에만 저장
- 커밋이 발생하기 전까진 데이터베이스에 기록하지 않음
- 중간에 장애가 생기더라도 데이터베이스에 기록되지 않았으므로 UNDO가 필요 없음(미실행 된 로그 폐기)

### 즉시갱신 회복 기법(Immediate Update)

- 트랜잭션 수행 도중에도 변경 내용을 즉시 데이터베이스에 기록
- 커밋 발생 이전의 갱신은 원자성이 보장되지 않는 미완료 갱신이므로 장애 발생 시 UNDO 필요
  <br>

## 2. 검사점 회복기법

- ### 장애 발생 시 검사점(Checkpoint) 이전에 처리된 트랜잭션은 회복에서 제외하고
- ### 검사점 이후에 처리된 트랜잭션은 회복 작업 수행
      검사점 이후, 장애 발생 이전에 commit이 완료된 경우 Redo 수행
      장애 발생 시점까지 commit되지 못한 경우 Undo 수행
  ![image](https://user-images.githubusercontent.com/71022555/137618327-7b17434f-a7bb-47f3-a5a7-15f37c75faa7.png)
  <br>

## 3. 미디어 회복 기법

- ### 디스크와 같은 비휘발성 저장 장치가 손상되는 장애 발생을 대비한 회복 기법
- ### 데이터베이스 내용을 백업, 미러링, RAID등을 통해 별도의 물리적 저장장치에 덤프
- ### 미디어 장애 시 가장 최근 덤프로 복구하고 로그 파일을 참조해 덤프 이후의 작업 Redo
- ### (Undo는 사용되지 않음)
<br>

## 4. 그림자 페이징 회복 기법

- ### 트랜잭션이 실행되는 메모리상의 Current Page Table과 하드디스크의 Shadow Page Table 이용
- ### 트랜잭션 시작시점에 Current Page Table과 동일한 Shadow Page Table 생성
- ### 트랜잭션이 성공적으로 완료될 경우 Shadow Page Table 삭제
- ### 트랜잭션이 실패할 경우 Shadow Page Table을 Current Page Table로 함
<br>

## 5. ARIES 회복 기법

- ### REDO 중 Repeating history
  붕괴가 발생했을 때의 데이터베이스 상태를 복구하기 위하여 붕괴 발생 이전에 수행했던 모든 연산을 다시 한번 수행. 붕괴가 발생했을 때 완료되지 않은 상태였던 (진행 트랜잭션)은 UNDO
- ### UNDO 중 Logging:
  UNDO를 할 때에도 로깅을 함으로써 회복을 수행하는 도중에 실패하여 회복을 다시 시작할 때에 이미 완료된 UNDO 연산은 반복하지 않음

## Commit(커밋) 연산 commit;

### 변경된 데이터를 테이블에 영구적으로 반영하는 것 -> commit시 이전의 데이터 복구 불가능

<br>

## (ROLLBACK)롤백 rollback;

### 데이터 변경 사항을 취소하고 테이블의 데이터를 이전의 데이블 데이터로 복구한다.

<br>

## SAVEPOINT(저장점)

### 저장점을 사용하여 롤백할 때 커밋단위로 롤백하는것이 아니라 세이브 포인트를 설정하여 해당 위치로 롤백을 진행할 수있다.

### 생성 : SAVEPONT 저장점이름;

### 롤백 : ROLLBACK TO 저장점이름;
